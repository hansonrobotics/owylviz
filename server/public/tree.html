<!DOCTYPE html>
<html lang="en">
<body>
<div id="container"></div>
<script src="http://code.jquery.com/jquery-1.11.2.min.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style>

#container {
  margin: 0 auto;
}

.node circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 2px;
}

.node {
  font: 12px sans-serif;
}

.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 2px;
}

</style>
<script>

  var socket = io.connect('http://' + location.host + '/display');
  socket.on('connect', function() {
    socket.emit('join room', location.pathname.slice(1));
    socket.on('tree', function(structure) {
      console.log('tree: ' + JSON.stringify(structure));
      update_tree(structure);
    });
    socket.on('step', function(id) {
      console.log('step: ' + id);
    });
  });

  var r = 10,
      padding = [140, r*1.4];

  var svg = d3.select("#container").append("svg")
      .attr("width", "100%")
      .attr("height", "100%")
    .append("g")

  function update_tree(structure) {
    var tree = d3.layout.tree()
        .nodeSize([r*4, r*10]);

    var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.y, d.x]; });

    var nodes = tree.nodes(structure),
        links = tree.links(nodes);

    var minX = Math.min.apply(null, nodes.map(function(n){return n.x})),
        maxX = Math.max.apply(null, nodes.map(function(n){return n.x})),
        width = padding[0]*2 + Math.max.apply(null, nodes.map(function(n){return n.y}));
        height = padding[1]*2 + maxX - minX;

    $("#container").width(width).height(height);
    svg.attr("transform", "translate(" + padding[0] + "," + (-minX + padding[1]) + ")");

    var link = svg.selectAll("path.link")
        .data(links)
      .enter().append("path")
        .attr("class", "link")
        .attr("d", diagonal);

    var node = svg.selectAll("g.node")
        .data(nodes)
      .enter().append("g")
        .attr("class", "node")
        .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; });

    node.append("circle")
        .attr("r", r);

    node.append("text")
        .attr("dx", function(d) {return d.children ? -r*1.4 : r*1.4;})
        .attr("dy", function(d) {return 3;})
        .attr("text-anchor", function(d) {return d.children ? "end" : "start";})
        .text(function(d) { return d.name; });
  }

</script>
</body>
</html>
